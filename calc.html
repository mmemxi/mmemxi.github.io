<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta property="og:locale" content="ja_JP" />
<meta name = "viewport" content = "width=device-width, initial-scale=1">
<title>コイン計数用ツール</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body style="margin:3%;width:96%;height:100%;overflow-x:hidden;font-size:120%;">
コイン計数用ツール<br>
<div align=right><a href="index.html"><img src="./image/back.png"></a></div>
<div id="maintable"></div>
<script type="text/javascript">
//----------------------------------------------------------------
var i,j,s,ss;

var viewLane=1;		//	表示中の現在レーン(1～7)
var viewMode=0;		//	0:現在値  1:目標値
var viewOrder=1;	//	0:降順    1:昇順
var voiceMode=false;
//----------------------------------------------------------------
var inputs;
var currentIndex = 0;
var recognition;
//----------------------------------------------------------------


// コインタイプ一覧
var coinType=new Array(1000,500,100,50,10,5,1);

// 平日デフォルト
defaultA=new Array("120,70,70,70,70,70,70","120,70,70,70,70,70,70","120,70,70,70,70,70,70","120,70,70,70,70,70,70","50,50,50,50,50,50,50","50,50,50,50,50,50,50","40,40,40,30,30,30,30");

// 土日祝日デフォルト
defaultB=new Array("150,80,80,80,80,80,80","150,80,80,80,80,80,80","150,80,80,80,80,80,80","150,80,80,80,80,80,80","50,50,50,50,50,50,50","50,50,50,50,50,50,50","40,40,40,30,30,30,30");

// 目標値テーブル
var targets=new  Array(7);
for(i=0;i<=6;i++){targets[i]=new Array(7);}

// 現在値テーブル
var tables=new  Array(7);
for(i=0;i<=6;i++)
	{
	tables[i]=new Array(7);
	for(j=0;j<=6;j++)
		{
		key=i+"&"+j;
		tables[i][j]=getLocaldata(key);
		}
	}

// 明日のデフォルト値を目標値テーブルにセットする
if (isTomorrowWeekend())
	{
	targets=setDefaults(defaultB);		//	土日デフォルト
	}
else{
	targets=setDefaults(defaultA);		//	平日デフォルト
	}
for(i=0;i<=6;i++)
	{
	console.log("目標値"+i+"="+targets[i]);
	}
voiceMode=false;
drawLanes();	//	レーンを表示する
document.getElementsByTagName("input")[0].focus();

function drawLanes()
	{
	var i,j,s,ss;
	var d1,d2,diff;
	var buf="<select size=1 id='pulldown_lane' onchange='changeLanes()' style='font-size:120%;'>";
	var totalKin=0;
	for(i=1;i<=7;i++)
		{
		buf+="<option value="+i;
		if (i==viewLane) buf+=" selected";
		buf+=">"+i+"レーン</i>";
		}
	buf+="</select><br><br>";

	buf+="<button style='font-size:120%' onclick='changeMode(";
	if (viewMode==0)
		{
		buf+="1)'>現在値";
		}
	else{
		buf+="0)'>目標値";
		}
	buf+="</button>";
	if (viewMode==0)
		{
		buf+="<button style='font-size:120%' onclick='resetIt()'>リセット</button>";
		}
	buf+="<br><br>";
	
	if (viewMode==0) buf+="<button id='voice' style='font-size:120%' onclick='voiceProcess()'>音声入力開始</button><br>";

	buf+="<div id='fld'><table border=1 cellspacing=0 cellpadding=4>";
	if (viewMode==0)
		{
		buf+="<tr style='background-color:#aaccff'><td align=center onclick='changeOrder()' style='cursor:pointer;'>金種";
		if (viewOrder==0) buf+="▼";else buf+="▲";
		buf+="</td><td align=center>差分</td><td align=center>現在値</td></tr>";
		}
	else{
		buf+="<tr style='background-color:#aaccff'><td align=center onclick='changeOrder()' style='cursor:pointer;'>金種";
		if (viewOrder==0) buf+="▼";else buf+="▲";
		buf+="</td><td align=center>目標値</td></tr>";
		}

	var loop1,loop2,loop3;
	if (viewOrder==0)
		{
		i=0;
		}
	else{
		i=coinType.length-1;
		}

	while(1==1)
		{
		buf+="<tr><td style='background-color:#3333ff;color:#ffffff;width:60px;text-align:right;font-weight:bold;'>";
		buf+=coinType[i].toLocaleString('ja-JP')+"</td>";

		//	目標合計を計算する（コインのみ）
		if (coinType[i]<1000)
			{
			v=targets[viewLane-1][i];
			if (v!="")
				{
				if (isNaN(v)==false)
					{
					totalKin+=parseInt(v,10)*parseInt(coinType[i],10);
					}
				}
			}

		//	差分列を表示する
		if (viewMode==0)
			{
			buf+="<td style='width:60px;text-align:center;font-size:120%;background-color:#ededff;' id='dif"+i+"'>";
			d1=targets[viewLane-1][i];
			d2=tables[viewLane-1][i];
			if ((d1!="")&&(d2!="")&&(isNaN(d1)==false)&&(isNaN(d2)==false))
				{
				dif=parseInt(d1,10)-parseInt(d2,10);
				if (dif!=0)
					{
					buf+="<span style='color:";
					if (dif>0) buf+="#0000ff;'>+"+dif;
					if (dif<0) buf+="#ff0000;'>"+dif;
					buf+="</span>";
					}
				}
			buf+="</td>";
			}
		buf+="<td style='width:60px;'>";
		buf+="<input type=number maxlength='3' id='coin"+i+"' style='border:none;text-align:right;width:60px;font-size:120%;'";
		buf+=" onfocus='this.select()' onchange='changeit("+i+")'"
		buf+=" value='";
		if (viewMode==0)
			{
			buf+=tables[viewLane-1][i];
			}
		else{
			buf+=targets[viewLane-1][i];
			}
		buf+="'></td>";
		buf+="</tr>";

		if (viewOrder==0)
			{
			i++;
			if (i>=coinType.length) break;
			}
		else{
			i--;
			if (i<0) break;
			}
		}
	buf+="</table></div><br>";
	buf+="<div style='font-size:120%'>コイン合計額：￥"+totalKin.toLocaleString('ja-JP')+"</div><br>";
	if (viewMode==1)
		{
		buf+="<button style='font-size:120%' onclick='presetDefault(0)'>平日の目標値</button><br>";
		buf+="<button style='font-size:120%' onclick='presetDefault(1)'>土日祝の目標値</button><br>";
		}
	document.getElementById("maintable").innerHTML=buf;
	}

function presetDefault(num)
	{
	if (num==0)
		{
		targets=setDefaults(defaultA);		//	平日デフォルト
		}
	else{
		targets=setDefaults(defaultB);		//	土日祝デフォルト
		}
	drawLanes();
	}

function resetIt()
	{
	var r=confirm("現在値をリセットしてもよろしいですか？");
	if (!r) return;
	var i,j;
	for(i=0;i<=6;i++)
		{
		tables[viewLane-1][i]="";
		key=(viewLane-1)+"&"+i;
		setLocaldata(key,"");
		}
	drawLanes();
	}

function changeLanes()
	{
	viewLane=document.getElementById("pulldown_lane").selectedIndex+1;
	drawLanes();
	}

function changeMode(mode)
	{
	viewMode=mode;
	drawLanes();
	}

function changeOrder()
	{
	if (viewOrder==0) viewOrder=1;else viewOrder=0;
	drawLanes();
	}

function changeit(p)
	{
	var v=document.getElementById("coin"+p).value;
	var vv;
	var d1,d2,dif,dview;
	var nf=false;
	v=v.trim();
	if (isNaN(v)) v="";
	else v=parseInt(v,10);
	if (viewMode==0)
		{
		tables[viewLane-1][p]=v;
		key=(viewLane-1)+"&"+p;
		setLocaldata(key,v);
		drawLanes();
		}
	else{
		targets[viewLane-1][p]=v;
		}
	
	if (v!="") nf=true;
	if (nf)
		{
		if (viewOrder==0)
			{
			p++;
			if (p>=7) p=0;
			}
		else{
			p--;
			if (p<0) p=6;
			}
		document.getElementById("coin"+p).focus();
		}
	}

//----------------------------------------------------------
// 翌日が土日であるかどうか返す
function isTomorrowWeekend()
	{
	var today = new Date();
	var tomorrow = new Date(today);
	tomorrow.setDate(today.getDate() + 1);
	var day = tomorrow.getDay(); // 0=日曜, 1=月曜, ..., 6=土曜
	return day === 0 || day === 6;
	}

// デフォルト値を展開したテーブルを返す
function setDefaults(src)
	{
	var i,j,s,v;
	var tbl=new Array(7);
	for(i=0;i<=6;i++)
		{
		tbl[i]=src[i].split(",");
		}
	return tbl;
	}

//---------------------------------------------------------------------
// localdata関連処理
//---------------------------------------------------------------------
function getLocaldata(key)
	{
	var result="";
	var ld=localStorage.getItem(key);
	if (ld!=null) result=ld;
	return result;
	}

function setLocaldata(key,val)
	{
	localStorage.setItem(key,val);
	}

//---------------------------------------------------------------------
// 音声入力関係
//---------------------------------------------------------------------
function parseJapaneseNumber(text)
	{
	const map = {
	"ぜろ":0,"れい":0,"いち":1,"に":2,"さん":3,"よん":4,"し":4,"ご":5,
	"ろく":6,"なな":7,"しち":7,"はち":8,"きゅう":9,"く":9,
	"じゅう":10,"じゅ":10,"ひゃく":100
		};
	text = text.replace(/\s/g, "").replace(/ー/g, ""); // 空白や長音削除

	// 数字で話した場合（例：「２５」）
	if (/^\d{1,3}$/.test(text))
		{
		const n = parseInt(text, 10);
		return (n >= 0 && n <= 999) ? n : null;
		}

      let total = 0;
      let hundreds = 0, tens = 0, ones = 0;

      // 「～ひゃく～じゅう～」構造を解析
      const h = text.split("ひゃく");
      if (h.length > 1) {
        const hundredPart = h[0];
        hundreds = hundredPart ? (map[hundredPart] || 1) * 100 : 100;
        text = h[1];
      }

      const j = text.split("じゅう");
      if (j.length > 1) {
        const tenPart = j[0];
        tens = tenPart ? (map[tenPart] || 1) * 10 : 10;
        text = j[1];
      }

      // 残りが一桁
      if (text && map[text] != null) {
        ones = map[text];
      }

      total = hundreds + tens + ones;
      return total > 0 ? total : null;
	}

//---------------------------------------------------------------------
function voiceProcess()
	{
	if (!('webkitSpeechRecognition' in window))
		{
		alert("このブラウザは音声認識に対応していません。");
		return;
		}

	var dom=document.getElementById("voice");
	if (voiceMode)
		{
		voiceMode=false;
		if (recognition) {
			recognition.onend = null;
			recognition.stop();
			recognition = null;
			}
		dom.innerText="音声入力開始";
		}
	else{
		voiceMode=true;
		dom.innerText="音声入力中断";
		currentInput=0;
		inputs = document.querySelectorAll("#fld input");
		inputs[currentIndex].focus();
		voiceInput();
		}
	}

function voiceInput()
	{
	recognition = new webkitSpeechRecognition();
	recognition.lang = "ja-JP";
	recognition.interimResults = false;
	recognition.continuous = false;

	recognition.onresult = (event) => {
		const result = event.results[0][0].transcript.trim();
		const num = parseJapaneseNumber(result);
		var y;
		if (viewOrder==0)	y=currentIndex;
					else	y=6-currentIndex;
		if (num !== null && num >= 0 && num <= 999)
			{
			inputs[currentIndex].value = num;
			tables[viewLane-1][y]=num;
			var key=(viewLane-1)+"&"+y;
			setLocaldata(key,num);
			var d1=targets[viewLane-1][y];
			var d2=num;
			var buf="";
			var dif=parseInt(d1,10)-parseInt(d2,10);
			if (dif!=0)
				{
				buf="<span style='color:";
				if (dif>0) buf+="#0000ff;'>+"+dif;
				if (dif<0) buf+="#ff0000;'>"+dif;
				buf+="</span>";
				}
			document.getElementById("dif"+y).innerHTML=buf;

			currentIndex++;
			if (currentIndex >= inputs.length)
				{
				recognition.stop();
				currentIndex=0;
				document.getElementById("voice").innerText="音声入力開始";
				}
			else{
				inputs[currentIndex].focus();
	            recognition.start(); // 次の入力へ
				}
			}
		else{
			alert("数字が認識できませんでした。もう一度お願いします。");
			recognition.start(); // 同じフォームで待機
			}
		};

	recognition.onerror = (event) => {
		console.error("エラー:", event.error);
		if (event.error !== "no-speech") {
			recognition.stop();
			}
		};

	// 全部終わる前に勝手に切れた場合、まだ残りがあれば再開
	recognition.onend = () => {
		if (currentIndex < inputs.length)
			{
			setTimeout(() => {if (recognition) recognition.start();}, 300);
			}
		};
	recognition.start();
	}
</script>
</body>
</html>
